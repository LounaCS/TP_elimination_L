---
title: "Count_matrix_analyses"
author: "LounaCS"
date: "12/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import the data with tximport
## build metadata


```{r}
library(tidyverse)

sampleTable = read_delim("metadata_samples.tsv") %>% as.data.frame()
rownames(sampleTable) = sampleTable$sample_ID
sampleTable
```

# data import using tximport

```{r}
library(tximport)

dir <- "/home/rstudio/mydatalocal/TP_elimination_L/3_processed_data/quantification/"
samples <- list.dirs(dir, full.names = F) 
samples <- samples[samples != ""] # remove "." directory

samples_names <- rownames(sampleTable)

files <- file.path(dir, samples_names, "abundance.h5")
names(files) <- samples_names
files[!file.exists(files)]


txi.kallisto.tmp <- tximport(files[1], type = "kallisto", txOut = TRUE)

transcript_names <- rownames(txi.kallisto.tmp$abundance)
tx2gene <- data.frame(tx=transcript_names,
                  gene=gsub(".t[0-9]*","",transcript_names))
txi.kallisto <- tximport(files, type = "kallisto", tx2gene = tx2gene)
```

# Differential expression analyses
## build the DESeq2 object



```{r}
library(DESeq2)

sampleTable$during = "not during"
sampleTable$during[sampleTable$timing == "during"] = "during"

dds <- DESeqDataSetFromTximport(txi.kallisto, sampleTable, ~ elimination )
dds <- DESeq(dds)
#DESeq compares statistically genetic expression under different hypothetic factors. also normalize the count matrix.
vsd <- vst(dds, blind=FALSE)
```
 
 replicats proches sur la PCA: bien!
 courbe de temps: PC1 suivant le temps.
 
# ACP display
```{r}
plotPCA(vsd, intgroup=c("age"))
```
 
```{r}
res = results(dds)
```

## Plot orientation
```{r}
resultsNames(dds)
```
Up on the plot: 

```{r}
plotMA(res, ylim=c(-30,30))
```
 We want to identify the significatively upregulated genes.
 
 
 ## Manipulation of res
 
 We can't identify all upregulated genes, so first focuss on the most upregulated genes.
```{r}
res_df <- as.data.frame(res)
head(res_df)
```
 
```{r}
subset(res_df, log2FoldChange > 20 & baseMean > 10 & padj < 0.05)
```

```{r}
summary(res)
```

We obtain 1163 gene upregulated.

To identify them:
 - plot their expression profile
 - identify their category

```{r}
plotCounts(dds, gene="mbelari.g8166", intgroup = "age")
```

